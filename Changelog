4.11
====
deprecation notice:
 - In order to avoid conflicting use of variables inside .desc file and
variables in other mkswu itself or other desc files, swdesc_* commands
and mkswu itself will stop processing some variables that have been used
directly such as 'version' in the past.
Please use swdesc_option or swdesc_* --<option> instead. Use of these
variables will display a warning, and will stop working in new swu
created after 2024/04.

fixes:
 - version normalization had a few problems, in particular leading zeroes
were incorrectly removed in some cases (after a succession of dashes,
where it should be considered as a string). The normalization now happens
during preprocessing at mkswu step and should be more correct.
 - avoid using incompatible desc when running kernel_update_plain install
script
 - fix running on qemu-based ABOS (only useful for testing)

features:
 - Support smaller boot partition sizes: the boot image is no longer
padded, and environment is cleared during install based on offsets in
the fw_env.config file
 - Automatically pad leading 1KB of boot image if required: older image
format (used for imx6ull) requires being written from the 1KB offset of
the boot partition; pad the image so the actual image starts at the
correct offset if required
 - Improve comments in /etc/swupdate.pem for newly created certificates.
The comment will be present in the certificate on ATDE side as well,
and will contain the common name as well as the file name now.
 - Improve error messages in podman scripts. The errors now have the same
dash banner as other errors.
 - Add support for command descriptions printing progress-like messages
as install is executed on compatible versions of swupdate.
 - mkswu --show will now output something closer to the desc file itself
by default. It is not recommended to use as is, but can be used to
reproduce part of a swu.
 - /tmp is now mounted as a tmpfs for swdesc_exec (and script, command);
the directory can be used to produce temporary data.
 - Allow running mkswu as a symlink to the script in git directory.
 - Add /etc/udev/rules.d to the default swupdate_preserve_files.
 - Armadillo A6E: add a6e-gw-container to swupdate.watch

experimental:
 - swdesc_exec has gained a --container option which allows running
command from an arbitrary container. This can be used to perform tasks
that are difficult to do on Base OS (due to e.g. lack of dependencies).
In this case, the partition being installed to is mounted as /target.
This might go away in the future and should not be relied on yet.

 -- 2023-04-25

4.10.1
======
fixes:
 - fix 'mkswu -- <desc>' invocations
 - fix swdesc_* --opt=value invocations
 - add bash completion for --update-version

 -- 2023-03-27

4.10
====
fixes:
 - only copy files present in swupdate_preserve_files from rootfs, not from
overlayfs. This prevents accidental copies of files that weren't persited when
an update is installed.
 - fix URL used for a6e when auto-update is enabled. The url now comes from
the rootfs and is left untouched. (the release build will fix previously
incorrectly filled URLs by checking the current hwrevision)
 - fix various versions handling, in particular comparison was not properly
done in some corner cases (semvers with or without a dash component, version
with leading zeroes being incorrectly considered different...)
 - use sub-second precision for cached files validity, this helps when
 running mkswu in a tight loop for e.g. tests when the generated file also
 could not be differentiated by size.

features:
 - add mkswu --update-version to update .desc files version fields
 - add examples/kernel_update_plain.install.sh helper script for kernel
updates
 - handle --opt=value in swdesc_* commands (e.g. swdesc_files --dest=/dir)

 -- 2023-03-27

4.9
===
fixes:
 - add /etc/containers/aiot_gw_container_hooks.d to preserve_files default
paths for Armadillo-IoT Gateway A6E

 -- 2023-01-26

4.8
===
fixes:
 - mkswu prints help if no argument given.
 - some runlevel files for LTE model such as ems31-boot are preserved if
needed.
 - restore/add the following services on Base OS update:
    - G4 LTE model:
      - del modemmanager (started by udev), add wwan-safe-poweroff
    - A6E Cat.M1 model:
      - add ems31-boot, wwan-led, wwan-safe-poweroff
    - A6E Cat.1 model:
      - add modemmanager, wwan-led, wwan-safe-poweroff
 - check for rebooting in try_lock to avoid a second update while
rebooting on the first update.

features:
 - Add support for wifi-recover for future updates.
Preserving files, enabling the service as required. wifi-recover and
podman-atmark in /etc/conf.d are reserved as 'POST'.

 -- 2022-12-23

4.7.1
=====
fixes:
 - Fix 'Nothing to do' version check when rollback is disabled,
the check was incorrectly disabled in this case in mkswu 4.7

 -- 2022-11-28

4.7
===
breaking changes:
 - Passwords used to be copied from live system (overlay) if not set
in the installed image, e.g. after a Base OS upgrade.
This caused troubles when operators would log in for diagnostic on the
installer system, so the copy now only considers files stored on rootfs
with persist_file (or previously updated through initial_setup)

fixes:
 - Files would not be compressed when included through a symbolic link.
In particular, container images embedded in SWU (swdesc_embed_containers)
were no longer compressed in version 4.6 due to an unrelated change
making it use a symlink.
Fix the size check to consider dereferenced file size.
 - Fix incorrect CRC error if any single file is bigger than 2GB
This is a bug in GNU cpio, which we work around by disabling CRC
annotation when a compressed file is this big. We already have
checksums of the files themselves, so this is not required.
 - Fix intermediate file being incorrectly removed if source for
swdesc_files is inside the output temporary files directory.
 - hawkbit-compose: fix path used for mysql extra config.
This extra config only sets an alternative encoding for the database,
so the only issue with this is that japanese could not be used in
various description fields. (Repairing this for existing installations
requires converting the DB if required)

features:
 - Unset and re-set (if appropriate) upgrade_available in uboot env
during installs. This avoids trying to rollback into a partially
installed system.
 - Avoid warnings in dmesg when mounting filesystems by always specifying
the filesystems types for mount and not trying to mount the old target
system when upgrade_available is unset.
 - Add a warning if a container image was included in a SWU but deleted
immediately due to lack of configuration file using it.
This is just a warning that can safely be ignored if done on purpose,
but should help diagnostic if this was a mistake.
 - Remove dependency to 'strings' to extract boot image version.
 - Also print 'included x.desc' message for the first desc file in case
multiple files were given. This is more consistent, in particular if an
output filename was set that is different from the first desc file name.

 -- 2022-11-24

4.6
===
fixes:
 - /!\ mkswu --init would incorrectly enable auto-updates even when disabled
during the question /!\
This was broken since 4.3 (included), if you have generated a new mkswu
config with mkswu 4.3, 4.4 or 4.5 and did not want autoupdate please:
    - remove autoupdate lines from initial_setup.desc and regenerate its swu
    - disable swupdate-url service on armadillo with the following mkswu
    command:
        swdesc_command 'rc-update del swupdate-url default'
    or directly on armadillo:
        persist_file -dv /etc/runlevels/default/swupdate-url
 - fix swupdate logs when using swdesc_pull_container (removed useless inspect
message)
 - make sure bolt_state.db is removed in persistent storage when using
non-standard paths. Podman refuses to start if we leave it behind.
 - improve changed file detection; in particular make sure we resign files
if certificate or key changed.

features:
 - add compatibility with abos-base 1.12-r0:
    - preserve containers storage.conf additionalimagestore setting
    - write directly in persistent development storage if it is in use.
 - improve logs when updating in persistent storage case
 - allow multiple identical swdesc_exec in same swu if arguments differ.
This is useful for using the same swdesc_script with different parameters,
as can be done when using multiple desc files that update preserve files
 - handle swdesc from stdin as '-' as done by other software
 - add support for installing swu in SD installer. This was already
technically possible with reboots, but we can now install extra swu
directly at the end of install without extra reboot.

 -- 2022-10-20

4.5
===
fixes:
 - fix script not waiting for podman containers to stop properly
in podman-storage --disk mode

 -- 2022-09-26

4.4
===
breaking changes:
 - /boot/uboot_env.d env is always applied after every updates,
not only for boot image updates.

features:
 - `mkswu --genkey --aes` now can generate new keys. This interface
still might slightly change.
 - add uboot_env.d and machine-id to default preserve files
 - refuse to apply uboot env if no bootcmd is set, e.g. defaults
are lacking.
 - use podman stop instead of podman kill for containers update.
This gives a chance for containers to shut down cleanly before kill.

fixes:
 - remove a few referneces to mmcblk2, this fixes mkswu when eMMC is
at a different index.

 -- 2022-08-26

4.3
===
breaking changes:
 - mkswu --genkey will now prompt for new key creations if a key
already exists. Use --noprompt for non-interactive uses.

features:
 - setting UPDATE_CERTS in mkswu.conf will send certificates in
$PUBKEY to device's /etc/swupdate.pem
(this is set automatically when genkey command generates new keys)
 - initialize uboot env with content from /boot/uboot_env.d/* on
boot image updates, and provide a script to update env immediately

fixes:
 - fix atmark user password not being preserved on updates (broken
in 4.1)
 - POST_ACTION=container would sometimes fail to umount podman readonly
storage, leading to an extra reboot
 - post install script would sometimes fail to notice errors from podman
commands (cleanup only)

 -- 2022-07-25

4.2
===
breaking changes:
 - the atmark user will automatically be locked if it has no password
set. This reflects an update to rootfs for alpine 3.16.0-at.1
 - update swupdate.cfg loglevel to 3 (info) if it was previously set to 2
(warn). Running with warn would show no message at all with new version.

features:
 - improve log messages: new swupdate version allows us to be more expressive
with info and warning messages, so make use of these if available.
 - add second atmark public certificate to /etc/swupdate.pem if and only
if the first one was present
 - update swupdate_preserve_files to v4. This adds /etc/dnsmasq.d,
/etc/sysctl.d, /etc/hostapd/hostapd.conf, /etc/runlevels/default/hostapd,
/etc/iptables/rules{,6}-save, /etc/runlevels/default/ip{,6}tables
 - improve guidance messages for hawkbit-compose setup_container.sh

 -- 2022-06-24

4.1
===
breaking changes:
 - rename ENCRYPT_FS to ENCRYPT_USERFS. This option was never documented
but one example used it; using swdesc_option ensures an error happens if
it is used.
 - default atmark password for --init is now locked instead of root
password

fixes:
 - mkswu --init would generate an invalid 'atmark' user password
since version 3.15-at.2, fix it and make --init again correct it as well
 - forbid installing another update while reboot is in progress.
This would sometimes cause a new partial rootfs copy and reboot into
a broken system

features:
 - include mkswu version in a comment in sw-description, so version used
to generate swu can be checked later
 - add mkswu --show to display swu content
 - ROOTFS_FSTYPE will default to whatever current system is currently in
use, so does not need to be set in all updates.
 - similarly, disk encryption is now automatically replicated if rootfs
is currently encrypted
 - run fstrim on rootfs after install. This helps MMC performance a
little bit.

 -- 2022-05-26

4.0
===
This release changes numbering system to unlink mkswu from baseos:
mkswu and baseos do not share a lifecycle and sharing version was
needless work.

fixes:
 - fix size/mtime check to consider real file and not symlink in case of
no encryption and already compressed files
 - sync and dismount installed system before flipping boot switch:
this ensures the system should not be broken if power is cut immediately
after boot switch/notification.
 - fix temporary cleanup of unused files

 -- 2022-04-27

3.15-at.6
=========
features:
 - add NOTIFY_STARTING_CMD, NOTIFY_FAIL_CMD, NOTIFY_SUCCESS_CMD handling
 - add swdesc_option for settings in sw-description (FORCE_VERSION and co)
setting environment variables directly is still supported.
Some of these options can also be set in /etc/atmark/baseos.conf with
MKSWU_ prefix when it makes sense to do so (e.g. NOTIFY_*_CMD or POST_ACTION)
 - do not reinstall "useless" updates when boot image needs updating as that
would wipe previous OS to rollback to.

experimental:
- add swdesc_boot_enc and swdesc_boot_linux for encrypted linux update.
These are still susceptible to change.

fixes:
 - check for all files size/mtime instead of just checking 'is newer' for
swdesc_files, compression and hash. This avoids hash mismatch errors
 - network connectivity check for hawkbit_register failed as script did not
have net_raw permission to ping. use nc instead.
 - fix copying boot image over to other partition, the image was not always
copied until the end

 -- 2022-04-25

3.15-at.5
=========
fixes:
 - fix install on very old swupdate where swupdate -g might not include /dev
 - fix podman_cleanup corner cases with infra image
 - fix sha256sum file not being updated properly sometimes (if zst archive
   changed without changing base file)

 -- 2022-04-08

3.15-at.4
=========
breaking change:
 - component, version and install_if variables are reset before parsing each
desc file. component is set to desc file name, the other two are emptied.

features:
 - allow setting ZSTD_CLEVEL to change compression level
 - log update contents to at-log and store last update partition to
/var/log/swupdate/last_update
 - add update_preserve_files.sh helper script to manage this file
 - allow trailing arguments for swdesc_script
 - set FW_UPDATE_IND after install unless no reboot is needed
 - add --extra-os swdesc_* switch that adds extra_os. to component
 - hawkbit-compose japanese translation

fixes:
 - PRIVKEY_PASS wasn't escaped properly
 - fix hawkbit service restart for POST=container updates with hawkbit

 -- 2022-03-24

3.15-at.3
=========
breaking changes:
 - rename hawkbit/create-updates.sh to hawkbit_push_update and install it
to bin dir

features:
 - add NO_PRESERVE_FILES option to skip handling copyback when using custom
rootfs
 - full rework of hawkbit container: use hawkbit-compose/setup_container.sh
to generate appropriate docker-compose.yml and config files

fixes:
 - fix sw-versions handling for board-specific updates (e.g. boot image) that
might generate multiple lines. This was harmless. Such duplicate lines will
also now be removed.
 - improve various error messages
 - do not try to wait for podman containers to stop if none were running
 - install base_os first if present in the image. This allows running
swdesc_exec or similar even if a base_os update is coming that would
previously fail because /target is empty

 -- 2022-02-18

3.15-at.2
=========
breaking changes:
 - desc files: disallow using the same component with multiple versions
previously the highest version would be kept for updating sw-versions, but
this is no longer manageable with install-if different.
- versions: disallow alnum mix in semver versions (e.g. 1.2.3-abc1),
Because swupdate ordering and sort -V have different behaviour there.
- versions: also check for previously incorrectly identical versions
when using install-if different (big numbers in semver, + part of semver)
- rename mkimage.sh to mkswu and roll all secondary scripts within it,
suggesting to use the mkswu package instead of running from git.
- rename mkimage.conf to mkswu.conf (this should be transparently converted)


features:
 - version management: allow different versions for same component if
installed in a different board section
 - swdesc_*: add --install-if {different,higher} option to force mode
This can be useful to get more coherent behaviour with hawkbit
 - swdesc_tar/files: make relative paths relative to
/var/app/rollback/volumes for non-os upates. forbid '../'s, and
also forbid relative paths for os.
 - Japanese translation if LC_MESSAGES is set to ja*, and add more
messages overall
 - add mkswu --init for first setup, which will guide user through
key generation and fill in initial_setup.desc
 - add mkswu --import to import previously existing config into
$HOME/mkswu
 - add mkswu --version
 - add debian package

fixes:
 - examples/kernel_update_plain: fix comment, add modules
 - swdesc_tar/files: create destination directory if absent
 - kill swupdate post-update instead of waiting for openrc
to do it with plenty of failure messages
 - podman_cleanup: relax failure conditions when image is missing
but container does not autostart or autopulls the image

 -- 2022-01-21

3.15-at.1
=========
breaking changes:
 - desc files: paths have been made relative to desc files

features:
 - genkey.sh: automatically create/update default config
 - swdesc_tar: add --preserve-attributes switch

fixes:
 - podman_cleanup: handle new pod option
 - swupdate_preserve_files: fix directory copy
 - scripts: handle new overlayfs properly
 - post_app: fix possible failure case where swap happened but we error into
reboot case, leading to double-swap
 - version managements: do not remove extra_os versions on base_os update
 - examples/initial_setup.desc: fix using wrong public key for
/etc/swupdate.pem update

 -- 2021-12-21

3.14-at.2
=========
 - first public release

-- 2021-12-03
